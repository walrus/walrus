#!/usr/bin/python

# Script to read a network config from a file and send it
# over serial to an Arduino for network setup.
# Arduino must be already up and running for this to work

import serial, time, sys

# Check argument(s).
#
# First arg is filename.
# This should be the path from network/config/ to the file
#
# E.G. 'network.txt'
#
# This script should be run from the project root directory

if len(sys.argv) < 2:
    print "No filename given; try again."
    sys.exit(1)
else:
    filename = "network/config/" + sys.argv[1]

# Open config file, and exit if this is impossible
try:
    config_file = open(filename,"r")
except IOError:
    print "Could not open file  " + filename +  "  please check the file exists"
    sys.exit(1)

# Open a Serial connection to the Arduino:
print "Connecting..."
try:
    arduino = serial.Serial('/dev/ttyACM0', 9600, timeout=1)
except:
    print "Failed to connect on /dev/ttyACM0"
    sys.exit(2)

print "success"

# Wait for the 'ready' signal
msg = ""
while "Ready" not in msg:
    msg = arduino.readline()
    print msg

arduino.reset_input_buffer()

print "Writing"

# Read input from config file and write to serial, as well as to the screen
line = config_file.readline()
while line:
    print line
    arduino.write(line)
    line = config_file.readline()

arduino.write('#')
print "Finished sending"

while "Received" not in msg:
    msg = arduino.readline()
    if msg:
        print msg

# Wait for confirmation from Arduino
while "Finished" not in msg:
    msg = arduino.readline()
    if msg:
        print msg

config_file.close()

sys.exit(0)